{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary bg-opacity-25">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>FPL Power Outage Map - Northwest Florida
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="d-flex justify-content-end mb-3">
                    <a href="https://www.fplmaps.com/northwest" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt me-2"></i> Open in New Window
                    </a>
                </div>
                
                <!-- Server-side proxy approach - Load FPL map through our proxy -->
                <div class="embed-responsive">
                    <iframe src="{{ url_for('fpl_proxy') }}" style="width: 100%; height: 650px; border: 1px solid #dee2e6; border-radius: 0.375rem;" title="FPL Power Outage Map"></iframe>
                </div>
                
                <!-- Fallback content in case iframe fails -->
                <div id="fallback-content" class="py-4 text-center d-none">
                    <div class="alert alert-warning mb-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Unable to load the FPL Outage Map in this view.
                    </div>
                    
                    <p class="mb-4">Please try one of these alternatives:</p>
                    
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{{ url_for('fpl_proxy') }}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt me-2"></i> Open Map in New Tab
                        </a>
                        
                        <a href="https://www.fplmaps.com/northwest" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt me-2"></i> Open Official FPL Map
                        </a>
                    </div>
                    
                    <div class="mt-4">
                        <img src="{{ url_for('static', filename='images/fpl_outage_example.svg') }}" 
                             alt="FPL Outage Map Sample" class="img-fluid rounded shadow-sm" 
                             style="max-width: 600px;">
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light text-muted">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    Real-time power outage information from Florida Power &amp; Light.
                    Map shows current outages, estimated restoration times, and affected areas.
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Check if iframe loaded successfully, otherwise show fallback content
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.querySelector('iframe');
    const fallbackContent = document.getElementById('fallback-content');
    
    // Add load event listener
    iframe.addEventListener('load', function() {
        // Check if iframe content loaded properly
        try {
            const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
            // If we can't access the iframe document, it likely failed to load
            if (!iframeDocument) {
                showFallback();
            }
        } catch (e) {
            // If we get a security error, show fallback
            showFallback();
        }
    });
    
    // Add error event listener
    iframe.addEventListener('error', function() {
        showFallback();
    });
    
    function showFallback() {
        iframe.style.display = 'none';
        fallbackContent.classList.remove('d-none');
    }
    
    // Set a timeout in case the iframe never triggers load/error events
    setTimeout(function() {
        try {
            const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
            // Check if iframe has valid content
            if (!iframeDocument || !iframeDocument.body || iframeDocument.body.innerHTML.trim() === '') {
                showFallback();
            }
        } catch (e) {
            showFallback();
        }
    }, 5000);
});
</script>
{% endblock %}